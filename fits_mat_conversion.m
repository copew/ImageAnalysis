% This script is to create .mat files from .fits files as fitsread is not working on the
% hpc cluster for some reason. 

%% 
%this is a total list
%image_list =[603283,603279,603271,603262,603269,603263,603257,603253,602994,603006,603245,603007,603055,602983,602976,602971,602962,602952,602958,602966,602945,602951,602942,602935,602927,602921,602915,593960,593708,593978,593971,593987,594006,594000,594017,594035,594044,594051,594060,594080,594088,594095,594105,594116,594110,595806,594137,597777,597768,597794,597800,597812,597820,597786,597830,597838,599803,599797,599831,599850,599813,604094,603952,604089,604098,604083,607165,603944,604078,604057,607166,604071,604077,603911,603919,604105,603925,603922,603928,603941,603904,604061,604066,604055,604047,603987,604045,603976,603982,603963,603970,603966,603956,619678,619884,619809,619942,619868,619556,619896,619937,619926,619922,619932,619916,619911,619533,619852,619863,619859,619842,619837,619832,619847,619583,619815,619803,619799,619793,619579,619571,619538,619550,619877,619539,619460,619954,619465,619470,619476,619483,619489,619503,619508,619496,619515,619527,625891,625322,625333,625338,626172,625865,626171,625876,625887,625895,625908,625911,619953,625916,626166,625923,625930,625936,625958,625946,625951,626018,626047,626102,626103,626160,603288,603298,603292];
%this is the test list
% image_list=[603288, 593987, 619857, 619872, 619905, 625951];

% total list of surgical slides with invasive tumour from transneo 5th nov 2019 (463
% images)
% image_list = [602185,605745,599871,600227,600245,600268,600281,600283,600285,600340,600368,600402,600403,600405,600418,601682,601770,602173,602176,602196,602198,602199,602201,602209,602271,602588,602592,602597,602610,602611,602831,602889,602892,603346,603369,603386,603426,603427,603566,603568,603569,603570,603571,603572,603573,603574,603578,603587,603673,603701,604829,604830,604831,604835,605012,605017,605018,605019,605171,605172,605174,605177,605181,605182,605183,605184,605185,605187,605199,605738,605739,605741,605744,605752,605753,605754,605755,605756,605758,605759,605760,605761,606016,606023,606095,606096,606097,606098,606099,606100,606101,606102,606103,606844,607158,607162,607163,607421,607431,607432,607433,607434,607435,607463,607466,607468,607471,607624,607635,607959,607960,607961,607962,608021,608845,608847,608848,608858,608879,608883,608884,608885,608886,608888,611277,611278,611353,611354,611356,611438,611439,611440,611441,611444,611491,611492,611494,611495,611501,613609,613684,613695,614241,614665,614666,614706,614707,614771,614773,614778,614843,614844,616146,616147,616255,616304,616306,616307,616332,616358,616366,616718,616719,626117,626118,626119,626354,626357,626358,626360,626361,627482,627514,627515,627516,627518,627542,627544,628659,628739,628740,628741,628742,628743,628744,628754,628755,628756,628758,628778,628779,628844,628845,628846,628847,628848,628849,629146,629274,629275,629276,629277,629278,629279,629280,629332,629334,629336,629340,629341,629347,629383,629384,629387,629390,629449,629450,629452,636357,636358,636364,636365,636554,636724,637435,639740,640535,640536,640542,640543,640648,640649,640762,640776,640787,640794,640885,640886,640887,640888,643608,643611,643634,643635,643643,643644,643645,643649,643650,643652,643786,643787,643788,643789,643790,643805,643806,643810,643812,643813,643814,645886,645891,645899,645903,645908,645911,647083,647087,647088,647091,647092,647093,647099,647364,647365,647366,648036,648037,648060,648062,648110,648112,648115,648120,648121,648223,648224,648231,648233,648234,648532,648535,648542,649452,649456,649460,650508,650629,650867,650868,650958,650992,650993,651240,651241,651291,651292,651293,651294,651297,651300,651301,651302,651304,651308,651309,645875,600064,600077,600079,600118,600122,600123,600288,600289,600294,600333,600335,600336,600337,601731,601778,601780,602551,603602,603603,603606,603834,603852,605016,605021,605022,605023,605158,605160,605777,606076,606077,606080,606082,606086,606092,607510,607515,607516,607518,607957,611255,611297,611298,611299,611300,611301,611302,611303,611321,611410,614675,616714,616716,616717,626195,627500,627505,627506,627573,627574,627584,627585,627586,627587,628685,629094,629200,629201,629202,629210,629211,629252,629255,629304,629305,629306,629307,629308,629310,629408,629464,629467,629470,629473,629474,629475,629478,629483,629524,629525,629526,632941,633245,633290,636356,636366,639741,643610,643633,643642,643794,643799,643800,643801,643808,645857,645858,645901,645906,647094,647098,647100,647101,647367,647369,648046,648213,648222,648225,648226,648227,648228,648229,648232,648237,648536,648538,648541,649461,649462,649463,649924,649926,649927,649928,649929,651226,651232,611514,611518,611520,611521,643791,648216,627513];

%running list - to run
image_list=[650629,650867,650868,650958,650992,650993,651240,651241,651291,651292,651293,651294,651297,651300,651301,651302,651304,651308,651309,645875,600064,600077,600079,600118,600122,600123,600288,600289,600294,600333,600335,600336,600337,601731,601778,601780,602551,603602,603603,603606,603834,603852,605016,605021,605022,605023,605158,605160,605777,606076,606077,606080,606082,606086,606092,607510,607515,607516,607518,607957,611255,611297,611298,611299,611300,611301,611302,611303,611321,611410,614675,616714,616716,616717,626195,627500,627505,627506,627573,627574,627584,627585,627586,627587,628685,629094,629200,629201,629202,629210,629211,629252,629255,629304,629305,629306,629307,629308,629310,629408,629464,629467,629470,629473,629474,629475,629478,629483,629524,629525,629526,632941,633245,633290,636356,636366,639741,643610,643633,643642,643794,643799,643800,643801,643808,645857,645858,645901,645906,647094,647098,647100,647101,647367,647369,648046,648213,648222,648225,648226,648227,648228,648229,648232,648237,648536,648538,648541,649461,649462,649463,649924,649926,649927,649928,649929,651226,651232,611514,611518,611520,611521,643791,648216,627513];

%done
% 606098,606099,606100,606101,606102,606103,606844,607158,607162,607163,607421,607431,607432,607433,607434,607435,607463,607466,607468,607471,607624,607635,607959,607960,607961,602588,602592,602597,602610,602611,602831,602889,602892,603346,603369,603386,603426,603427,603566,603568,603569,603570,603571,603572,603573,603574,603578,603587,603673,603701,604829,604830,604831,604835,605012,605017,605018,605019,605171,605172,605174,605177,605181,605182,605183,605184,605185,605187,605199,605738,605739,605741,605744,605752,605753,605754,605755,605756,605758,605759,605760,605761,606016,606023,606095,606096,606097, 600281,600283,600285,600340,600368,600402,600403,600405,600418,601682,601770,602173,602176,602196,602198,602199,602201,602209,602271,602185,605745,599871,600227,600245,600268, 608021,608845,608847,608848,608858,608879,608883,608884,608885,608886,608888,611277,611278,611353,611354,611356,611438,611439,611440,611441,611444,611491,611492,611494,611495,611501,613609,613684,613695,614241,614665,614666,614706,614707,614771,614773,614778,614843,614844,616146,616147,616255,616304,616306,616307,616332,616358,616366,616718,616719,626117,626118,626119,626354,626357,626358,626360,626361,627482,627514,627515,627516,627518,627542,627544,628659,628739,628740,628741,628742,628743,628744,628754,628755,628756,628758,628778,628779,628844,628845,628846,628847,628848,628849,629146,629274,629275,629276,629277,629278,629279,629280,629332,629334,629336,629340,629341,629347,629383,629384,629387,629390,629449,629450,629452,636357,636358,636364,636365,636554,636724,637435,639740,640535,640536,640542,640543,640648,640649,640762,640776,640787,640794,640885,640886,640887,640888,643608,643611,643634,643635,643643,643644,643645,643649,643650,643652,643786,643787,643788,643789,643790,643805,643806,643810,643812,643813,643814,645886,645891,645899,645903,645908,645911,647083,647087,647088,647091,647092,647093,647099,647364,647365,647366,648036,648037,648060,648062,648110,648112,648115,648120,648121,648223,648224,648231,648233,648234,648532,648535,648542,649452,649456,649460,
%error can't find file
%607962,650508,
%done
%
%% load fits files and tidy up

for image = 1:size(image_list, 2)
    image_filenumber = image_list(image);
    % loading files
    data = fitsread(['/Volumes/Wei/Neoadjuvant/neoadjuvant_level2/level2_catalogues/' num2str(image_filenumber) '.fits'],'binarytable');
    info = fitsinfo(['/Volumes/Wei/Neoadjuvant/neoadjuvant_level2/level2_catalogues/' num2str(image_filenumber) '.fits']);
    % image_path = ['./IT_PT_zone/' num2str(image_filenumber) '.svs']
    
    % create indexing
    X_ind = 3;
    Y_ind = 4;
    overlap = 22;
    s2n=61;
    cell_ind = 62;
    
    %trim data
    data_trimmed = data;
    
    %remove non cells
    for i = 1:size(data, 2)
        data_trimmed{i} = data_trimmed{i}(data{cell_ind}~=0);
    end
    %remove overlaps
    data_tmp = data_trimmed;
    for i = 1:size(data_trimmed, 2)
        data_trimmed{i} = data_trimmed{i}(data_tmp{overlap} =='F');
    end
    %remove low signal to noise ratio (set threshold at 1.3 - discussed with A Dariush)
    data_tmp = data_trimmed;
    for i = 1:size(data_trimmed, 2)
        data_trimmed{i} = data_trimmed{i}(data_tmp{s2n} >= 1.3);
    end
    
    % and combine tumour and normal
    %data_trimmed{cell_ind}(data_trimmed{cell_ind} == 4) = 1;

    %now save the data
     data_mini = [data_trimmed{X_ind} data_trimmed{Y_ind} data_trimmed{cell_ind}];
    
    %save as .mat file
    save(['/Volumes/Wei/Neoadjuvant/trimmed_matlab_data/' num2str(image_filenumber) '.mat'], 'data_mini');
    
end

